%% given
% material properties
E = 29.5e6; %psi
A = 1; %in^2
% coordinates
x = [0; 40; 40; 0];
y = [0; 0; 30; 30];
% element cosines and sines
le = sqrt([(x(1)-x(2))^2+(y(1)-y(2))^2; ...
           (x(3)-x(2))^2+(y(3)-y(2))^2; ...
           (x(1)-x(3))^2+(y(1)-y(3))^2; ...
           (x(4)-x(3))^2+(y(4)-y(3))^2]);

l = -[(x(1)-x(2))/le(1); ...
      (x(3)-x(2))/le(2); ...
      (x(1)-x(3))/le(3); ...
      (x(4)-x(3))/le(4)];
    
m = -[(y(1)-y(2))/le(1); ...
      (y(3)-y(2))/le(2); ...
      (y(1)-y(3))/le(3); ...
      (y(4)-y(3))/le(4)];
% L matrix 
L = cell(4,1);
L{1} = [l(1) m(1) 0 0; 0 0 l(1) m(1)];
L{2} = [l(2) m(2) 0 0; 0 0 l(2) m(2)];
L{3} = [l(3) m(3) 0 0; 0 0 l(3) m(3)];
L{4} = [l(4) m(4) 0 0; 0 0 l(4) m(4)];
% local element K matrix
Kep = cell(4,1);
Kep{1} = E*A/le(1)*[1 -1; -1 1];
Kep{2} = E*A/le(2)*[1 -1; -1 1];
Kep{3} = E*A/le(3)*[1 -1; -1 1];
Kep{4} = E*A/le(4)*[1 -1; -1 1];

%% part a
Ke = cell(4,1);
Ke{1} = L{1}.'*Kep{1}*L{1};
Ke{2} = L{2}.'*Kep{2}*L{2};
Ke{3} = L{3}.'*Kep{3}*L{3};
Ke{4} = L{4}.'*Kep{4}*L{4};

%% part b
K = cell(4,1);
K(:) = {zeros(8)};

K{1}(1,1) = Ke{1}(1,1);
K{1}(1,2) = Ke{1}(1,2);
K{1}(1,3) = Ke{1}(1,3);
K{1}(1,4) = Ke{1}(1,4);
K{1}(2,1) = Ke{1}(2,1);
K{1}(2,2) = Ke{1}(2,2);
K{1}(2,3) = Ke{1}(2,3);
K{1}(2,4) = Ke{1}(2,4);
K{1}(3,1) = Ke{1}(3,1);
K{1}(3,2) = Ke{1}(3,2);
K{1}(3,3) = Ke{1}(3,3);
K{1}(3,4) = Ke{1}(3,4);
K{1}(4,1) = Ke{1}(4,1);
K{1}(4,2) = Ke{1}(4,2);
K{1}(4,3) = Ke{1}(4,3);
K{1}(4,4) = Ke{1}(4,4);

K{2}(5,5) = Ke{2}(1,1);
K{2}(5,6) = Ke{2}(1,2);
K{2}(5,3) = Ke{2}(1,3);
K{2}(5,4) = Ke{2}(1,4);
K{2}(6,5) = Ke{2}(2,1);
K{2}(6,6) = Ke{2}(2,2);
K{2}(6,3) = Ke{2}(2,3);
K{2}(6,4) = Ke{2}(2,4);
K{2}(3,5) = Ke{2}(3,1);
K{2}(3,6) = Ke{2}(3,2);
K{2}(3,3) = Ke{2}(3,3);
K{2}(3,4) = Ke{2}(3,4);
K{2}(4,5) = Ke{2}(4,1);
K{2}(4,6) = Ke{2}(4,2);
K{2}(4,3) = Ke{2}(4,3);
K{2}(4,4) = Ke{2}(4,4);

K{3}(1,1) = Ke{3}(1,1);
K{3}(1,2) = Ke{3}(1,2);
K{3}(1,5) = Ke{3}(1,3);
K{3}(1,6) = Ke{3}(1,4);
K{3}(2,1) = Ke{3}(2,1);
K{3}(2,2) = Ke{3}(2,2);
K{3}(2,5) = Ke{3}(2,3);
K{3}(2,6) = Ke{3}(2,4);
K{3}(5,1) = Ke{3}(3,1);
K{3}(5,2) = Ke{3}(3,2);
K{3}(5,5) = Ke{3}(3,3);
K{3}(5,6) = Ke{3}(3,4);
K{3}(6,1) = Ke{3}(4,1);
K{3}(6,2) = Ke{3}(4,2);
K{3}(6,5) = Ke{3}(4,3);
K{3}(6,6) = Ke{3}(4,4);

K{4}(7,7) = Ke{4}(1,1);
K{4}(7,8) = Ke{4}(1,2);
K{4}(7,5) = Ke{4}(1,3);
K{4}(7,6) = Ke{4}(1,4);
K{4}(8,7) = Ke{4}(2,1);
K{4}(8,8) = Ke{4}(2,2);
K{4}(8,5) = Ke{4}(2,3);
K{4}(8,6) = Ke{4}(2,4);
K{4}(5,7) = Ke{4}(3,1);
K{4}(5,8) = Ke{4}(3,2);
K{4}(5,5) = Ke{4}(3,3);
K{4}(5,6) = Ke{4}(3,4);
K{4}(6,7) = Ke{4}(4,1);
K{4}(6,8) = Ke{4}(4,2);
K{4}(6,5) = Ke{4}(4,3);
K{4}(6,6) = Ke{4}(4,4);

K = K{1}+K{2}+K{3}+K{4};
F = [0; 0; 20000; 0; 0; -25000; 0; 0]; %lb

%% part c
Kr = K([3 5:6], [3 5:6]);
Fr = F([3 5:6]);

Qi = Kr\Fr;
Q = [0; 0; Qi(1); 0; Qi(2:3); 0; 0];

%% part d
sigma = zeros(4,1);
sigma(1) = E/le(1)*[-1 1]*L{1}*Q(1:4);
sigma(2) = E/le(2)*[-1 1]*L{2}*[Q(5:6); Q(3:4)];
sigma(3) = E/le(3)*[-1 1]*L{3}*[Q(1:2); Q(5:6)];
sigma(4) = E/le(4)*[-1 1]*L{4}*[Q(7:8); Q(5:6)];

%% part e
Rb = K([1:2 4 7:8],:)*Q-F([1:2 4 7:8]);
R = [Rb(1:2); 0; Rb(3); 0; 0; Rb(4:5)];